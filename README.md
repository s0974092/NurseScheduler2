# 護理人員排班系統

## 專案簡介

本系統為醫療單位設計的護理人員排班管理工具，支援人員與班別管理、自動排班、班表查詢、樞紐分析、批次上傳/下載與多條件搜尋，並可依實務需求擴充。

---

## 主要功能
- **人員管理**（CRUD、病房分組、批次上傳/下載、篩選搜尋）
- **班別設定**（CRUD、病房欄位、批次上傳/下載）
- **特定人員排班偏好設定**（單一班別、雙班別週次模式）
- **星期天 On Call 管理**（主要/備援 On Call、批次設定、日期範圍查詢、人員篩選、編輯刪除功能）
- **🆕 請假管理系統**（CRUD、日期範圍查詢、批次上傳/下載、多種假別支援、核准狀態管理）
- **自動排班**（支援進階規則：每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註、排班偏好整合、請假檢查優先級）
- **班表查詢**（多條件搜尋、查詢結果匯出CSV、On Call 狀態顯示）
- **班表分析**（PivotTable.js 樞紐分析，支援拖曳分析）
- **權限管理**（管理員/護理人員角色權限分級）
- **班表異動紀錄**（完整稽核追蹤）
- 所有資料皆儲存於 SQLite，資料結構可擴充

---

## 安裝與啟動

1. **安裝 Python 3.8+**
2. **安裝必要套件**
   ```bash
   pip install -r requirements.txt
   ```
3. **啟動 Flask 伺服器**
   ```bash
   python app.py
   ```
4. **瀏覽器開啟**
   http://127.0.0.1:5000/

---

## 使用說明

### 基本操作流程
1. **登入系統**：使用管理員或護理人員帳號登入
2. **人員管理**：新增、編輯護理人員資料，設定病房分組
3. **班別設定**：定義各種班別（早班、小夜班、大夜班等）
4. **排班偏好設定**：為特定人員設定當月排班偏好（單一班別或雙班別週次模式）
5. **假日 On Call 管理**：設定週末與假日的 On Call 人員安排
6. **自動排班**：一鍵產生整月班表，系統會自動遵循排班偏好與規則
7. **班表查詢**：多條件搜尋班表，查看 On Call 狀態
8. **班表分析**：使用樞紐分析工具進行深度分析

### 進階功能
- **批次處理**：支援 CSV 格式的批次上傳/下載
- **月曆檢視**：FullCalendar.js 呈現班表，支援月份切換
- **異動追蹤**：所有班表編輯都會記錄在異動紀錄中
- **權限控管**：依角色顯示不同功能選單

---

## 專案規劃與開發日誌

請參閱 [DEVLOG.md](DEVLOG.md) 取得完整專案規劃、已完成功能與下一階段建議。

---

## 貢獻方式

歡迎 issue、pull request 或 fork 本專案，協助功能優化與錯誤修正。

---

## 聯絡方式

如有合作或技術諮詢需求，請於 GitHub issue 留言。

---

## 最新功能 (v2.5.0) - 請假管理系統

### 🎯 **完整的員工請假管理**
- **核心功能**：
  - 新增、編輯、刪除、查詢請假記錄
  - 支援多種假別：事假、病假、特休、婚假、喪假、產假、陪產假、其他
  - 日期範圍查詢與員工/假別篩選
  - 核准狀態管理（預設核准，可調整）
  - 請假天數自動計算與顯示

### 🔧 **批次處理與匯入匯出**
- **CSV模板下載**：標準化請假資料模板，含範例資料
- **批次上傳驗證**：
  - 員工編號存在性驗證
  - 日期格式與邏輯驗證（起始日期不得大於結束日期）
  - 假別有效性檢查
  - 錯誤訊息詳細回報，逐行顯示問題

### 🤖 **自動排班完美整合**
- **第一優先級檢查**：自動排班時首先檢查員工請假狀態
- **智能過濾**：請假期間的員工自動從排班候選名單中移除
- **無縫整合**：不影響其他排班規則（偏好設定、工時限制、班別一致性等）
- **排班邏輯順序**：請假檢查 → 偏好設定 → 例假日/休息日 → 工時限制 → 班別一致性

### 🎨 **使用者體驗優化**
- **統一設計風格**：延續系統粉色主題，響應式Bootstrap設計
- **直觀操作介面**：
  - Bootstrap Modal編輯視窗
  - HTML5日期選擇器
  - 動態篩選表單與即時搜尋
  - 視覺化狀態指標（已核准/未核准）
- **完整權限控制**：僅管理員可存取請假管理功能
- **詳細操作回饋**：成功/錯誤訊息完整提示

### 📊 **資料管理特色**
- **資料完整性**：完整的前後端驗證機制
- **查詢效能**：高效的日期範圍SQL查詢設計
- **資料安全**：完整的操作記錄與異常處理
- **擴展性**：支援未來功能擴展（如請假額度管理、審核流程等）

### ⭐ **星期天請假處理機制 (v2.5.1)**
- **智能天數計算**：
  - 星期天為法定例假日，不計入實際請假天數
  - 系統自動計算並排除期間內的星期天數量
  - 顯示格式：**5** 天 *(總 7 天，含 2 個星期天)*
  
- **排班表顯示規則**：
  - 請假的星期天在排班表中顯示為「例假日」
  - 平日請假顯示為「其他排休」（灰白色背景區分）
  - CSV匯出功能同步支援此顯示邏輯
  
- **自動排班限制**：
  - 請假期間包含星期天時，該星期天不安排大夜班
  - 星期天On Call安排會排除請假員工
  - 系統自動警告無法安排On Call的情況
  
- **用戶介面優化**：
  - 新增/編輯請假時顯示星期天處理說明
  - 天數詳情欄位顯示完整計算邏輯
  - 批次上傳提示包含星期天計算規則

---

## 最新功能 (v2.4.0) - 員工橫式排班表功能升級

### 📊 **員工橫式排班表介面優化**
- **導航體驗提升**：
  - 按鈕重新佈局至頁面上方，採用左右分佈設計
  - 新增「回首頁」按鈕，提供更便捷的導航路徑
  - 視覺平衡優化，操作更加直觀

### 🔧 **智能CSV匯出功能**
- **專業設定介面**：
  - 使用 Bootstrap Modal 建立跳出視窗設定
  - 點擊「匯出 CSV」觸發設定視窗，而非直接下載
  - 分組式設定介面，操作邏輯清晰明確

- **文字替代代碼系統**：
  - **班別替代**：早班、小夜班、大夜班可設定簡短代碼（如 D、E、N）
  - **休假替代**：例假日、休息日、空白可自訂代碼（如 H、R、-）
  - **自訂班別**：支援任意班別名稱的替代設定
  - **選擇性替代**：留空的欄位不進行替代，保持使用彈性

### 🎨 **使用者體驗升級**
- **視覺設計改進**：
  - 新增 Bootstrap Icons 圖示支援
  - 設定分組使用視覺區塊，提升介面可讀性
  - 按鈕樣式統一，符合系統整體設計語言

- **智能處理機制**：
  - 自動判斷文字類型並套用對應替代規則
  - 檔名智能標示：使用替代代碼時自動加上「_已替代」後綴
  - UTF-8 BOM 編碼確保中文完全相容

### 📋 **功能價值**
- **提升工作效率**：一鍵匯出可直接用於其他系統的格式化資料
- **降低人為錯誤**：自動化替代減少手動轉換的失誤風險
- **增強使用彈性**：使用者可根據實際需求自訂匯出格式
- **改善操作體驗**：直觀的設定介面讓功能更易於使用

---

## 最新功能 (v2.3.0) - 星期天 On Call 管理系統

### 📞 **星期天 On Call 管理功能**
- **精確定位**：專門針對星期天的 On Call 人員管理
- **完整 CRUD**：新增、編輯、刪除、查詢 On Call 設定
- **狀態管理**：支援主要 On Call、備援 On Call、休息三種狀態
- **批次分配**：自動為整月星期天輪流分配 On Call 人員
- **日期範圍查詢**：支援起始日期到結束日期的彈性查詢（最多一年）
- **人員篩選**：可篩選特定人員的 On Call 記錄
- **視覺化標識**：星期天以藍色背景特別標示
- **即時編輯**：Modal 視窗內完成新增、編輯、刪除操作

### 🔧 **技術特色**
- **前後端雙重驗證**：確保只能為星期天設定 On Call
- **智慧查詢**：支援月份模式和日期範圍模式切換
- **操作便利性**：本月快捷按鈕、清除搜尋、表單驗證
- **資料完整性**：完整的錯誤處理和使用者提示
- **權限控管**：需要管理員權限才能操作

### 🎨 **使用者介面優化**
- **統一色調**：延續系統粉紅主題
- **響應式設計**：支援不同螢幕尺寸
- **Font Awesome 圖示**：提供直覺的操作圖示
- **即時統計**：顯示查詢期間星期天總數

---

## 最新功能 (v2.1.0)

### 🎯 **四周變形工時與每日需求人數功能**
- **四周變形工時管理系統**：
  - 支援每月四周變形工時設定（預設啟用）
  - 每人每週工時不超過40小時
  - 可自訂例假日（預設週日，可調整為其他星期）
  - 自動安排例假日與休息日
  - 工時統計與警示功能
- **班別每日需求人數設定**：
  - 支援每個班別在週一到週日的不同需求人數
  - 保留原有「所需人數」作為預設值
  - 支援「複製到所有天數」與「重置為預設值」功能
  - 向後相容現有資料
- **週工時統計與警示系統**：
  - 新增「週工時統計」專頁
  - 顏色編碼顯示工時狀態（紅色超限、橘色不足、綠色正常）
  - 顯示工作天數、例假日、休息日統計
  - 警示缺少例假日或休息日

### 🎯 **特定規則功能**
- **特定人員排班偏好設定**：
  - 支援單一班別偏好（指定人員只值勤特定班別）
  - 支援雙班別偏好（指定人員值勤兩種班別）
  - 週次模式：交替週次（奇數週班別1，偶數週班別2）、連續週次（前兩週班別1，後兩週班別2）
- **假日 On Call 管理系統**：
  - 主要 On Call、備援 On Call、休息狀態管理
  - 批次自動分配週末 On Call
  - 月曆檢視，週末日期自動高亮顯示
  - 與班表查詢整合，顯示 On Call 狀態

### 🔧 **自動排班邏輯升級**
- 自動檢查人員排班偏好設定
- 支援週次模式自動分配
- 保持原有規則（11小時間隔、連續天數限制等）
- 資料完整性保護（只處理指定月份）

### 📊 **介面優化**
- 新增「排班偏好設定」與「假日 On Call 管理」專用頁面
- 班表查詢新增 On Call 狀態欄位
- 自動排班頁面新增「假日 On Call 整合」選項
- 保持淺粉紅主題色彩一致性

## 技術棧
- Python Flask
- Bootstrap 5
- FullCalendar.js（行事曆）
- PivotTable.js（樞紐分析）
- SQLite（資料儲存）

## 主要特色
- **人員/班別管理**（CRUD、批次上傳/下載、篩選搜尋）
- **特定人員排班偏好**（單一班別、雙班別週次模式）
- **星期天 On Call 管理**（日期範圍查詢、人員篩選、批次分配、即時編輯）
- **進階自動排班**（多規則、依病房分組、缺人自動標註、排班偏好整合）
- **班表查詢**（多條件搜尋、CSV匯出、On Call 狀態顯示）
- **月曆檢視**（FullCalendar，支援月份切換）
- **班表分析**（PivotTable.js）
- **權限管理**（管理員/護理人員角色權限分級）
- **班表異動紀錄**（完整稽核追蹤）
- **本月班數統計與警示**

## 下一步建議

### 短期優化（1-2週）
- On Call 與排班深度整合
- 偏好衝突檢查與報表功能
- On Call 提醒通知系統

### 中期發展（1-2個月）
- 進階偏好設定（更複雜的排班模式）
- 歷史資料分析與自動化建議
- 行動裝置響應式設計完善

### 長期規劃（3-6個月）
- AI 輔助排班（機器學習優化）
- 多院區支援與 API 整合
- 雲端部署與擴展

### 近期更新
- 班表分析頁面美化，活力綠主題、標題、說明、匯出CSV按鈕，PivotTable.js 介面現代化。
- 全站主色調改為淺粉紅，首頁及所有子頁面背景、標題、卡片、按鈕皆統一色系。
- 員工橫式排班表優化：日期下方新增星期，早班/小夜班/大夜班以不同底色顯示。
- 各頁按鈕與導覽動線優化：「員工橫式排班表」按鈕移至班表查詢頁「月曆檢視」右側，回首頁/回上一頁按鈕動線更直覺。
- staff頁面「批次上傳」「範本下載」按鈕版面與shift頁一致，並支援點擊自動上傳。
- staff頁面新增「篩選搜尋」功能，可依員工編號、姓名、職稱、病房即時過濾。
- 其他UI一致性優化與細節調整。
- 2025-06-xx 權限管理與使用者管理功能開發進度：
  - 全站登入保護，未登入自動導向登入頁。
  - 依登入者角色（管理員/護理人員）顯示不同功能選單。
  - 首頁右上角顯示登入者名稱與登出按鈕。
  - 管理員專用「使用者管理」頁面：可新增、編輯、刪除、批次上傳/下載使用者。
  - 月曆檢視頁面新增「員工姓名、病房、班別」篩選查詢功能。

## 2025-06-xx 重大功能更新
- 新增 schedule_log（班表異動紀錄）資料表，所有班表編輯/刪除自動寫入異動紀錄。
- 班表查詢、月曆檢視頁新增「編輯」按鈕，管理員可直接編輯/刪除班表。
- 編輯班表彈窗（modal）優化：
  - 員工編號欄位支援 select2，可搜尋員工編號或姓名。
  - 權限控管，僅管理員可操作。
  - 狀態欄位改為下拉選單（正常、請假、調班、加班、缺勤、其他）。
- schedule_log 頁面可查詢所有異動紀錄，顯示異動前後內容。
- 修正 select2 在 modal 內無法搜尋的問題，改為每次 modal 彈出時初始化。
- 全站介面一致性優化，移除除錯欄位，保留乾淨操作體驗。
- 所有更新已 commit 並 push 至 GitHub。

---

## 版本歷史

### v2.5.1 (2025-01-15) - 星期天請假處理機制完善
- ✅ 「其他排休」功能實現（請假與休息日視覺區分）
- ✅ 星期天請假處理邏輯（請假星期天顯示為例假日）
- ✅ 智能請假天數計算（自動排除星期天）
- ✅ 自動排班限制優化（請假星期天不安排大夜班/On Call）
- ✅ 用戶介面增強（詳細說明與統計資訊）

### v2.5.0 (2025-01-15) - 請假管理系統
- ✅ 完整的員工請假管理系統（CRUD、多種假別、核准狀態）
- ✅ 批次上傳/下載與CSV模板功能
- ✅ 自動排班整合（請假檢查設為第一優先級）
- ✅ 日期範圍查詢與多條件篩選
- ✅ 響應式介面設計與權限控制

### v2.4.0 (2025-01-02) - 員工橫式排班表功能升級
- ✅ 員工橫式排班表介面優化（導航按鈕重新佈局）
- ✅ 智能CSV匯出功能（跳出視窗設定、文字替代代碼系統）
- ✅ 使用者體驗升級（Bootstrap Icons、視覺分組、智能處理）
- ✅ 檔案格式化與命名優化

### v2.3.0 (2025-01-02) - 星期天 On Call 管理系統
- ✅ 星期天 On Call 管理功能完整實作
- ✅ 日期範圍查詢與人員篩選功能
- ✅ 批次分配與即時編輯功能
- ✅ 視覺化標識與操作體驗優化

### v2.2.0 (2024-12-27) - 大夜班分配系統重大升級
- ✅ 大夜班分配跨月份支援
- ✅ 靈活日期範圍分配模式
- ✅ 全站介面風格統一
- ✅ 資料庫結構優化與自動遷移
- ✅ 使用者體驗全面提升

### v2.1.0 (2025-06-xx) - 四周變形工時與每日需求人數
- ✅ 四周變形工時管理系統
- ✅ 班別每日需求人數設定
- ✅ 週工時統計與警示系統
- ✅ 資料庫結構擴充與遷移
- ✅ 介面整合與優化

### v2.0.0 (2025-06-xx) - 特定規則功能
- ✅ 特定人員排班偏好設定
- ✅ 假日 On Call 管理系統  
- ✅ 自動排班邏輯升級
- ✅ 介面整合與優化

### v1.x.x (2025-06-xx) - 基礎功能
- ✅ 權限管理與使用者管理
- ✅ 班表異動紀錄
- ✅ 月曆檢視功能
- ✅ 介面美化與優化

### v1.0.0 (2025-05-xx) - MVP 版本
- ✅ 人員/班別管理
- ✅ 自動排班（基礎規則）
- ✅ 班表查詢/分析
- ✅ CSV 匯入匯出 

## 系統排班邏輯說明（2024-06更新）

### 主要規則
1. 每天每個班別都會依照設定需求人數自動排班，確保無缺班。
2. 每位員工每週日（例假日）固定休假，僅排一位員工上大夜班，其餘班別週日不上班。
3. 每位員工每週隨機分配一天休息日（週一到週六），該天不排班。
4. 週一到週六依需求公平分配班別，盡量平均分配班數。
5. 若人力不足，允許同一人多排班，但不允許班別缺人。
6. 排班結果於橫式班表中顯示，例假日/休息日有明確標記。

### 其他功能
- 支援每日班別需求人數自訂。
- 支援四周變形工時、夜班限制、連續上班天數等進階規則。 