<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è‡ªå‹•æ’ç­</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #fff0f6; }
        h2 { color: #d72660; }
        .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-info, .btn-secondary {
            border: none;
        }
        .btn-primary { background: #ffb6d5; color: #d72660; }
        .btn-primary:hover { background: #ffd6e0; color: #d72660; }
        .btn-success { background: #ffd6e0; color: #d72660; }
        .btn-success:hover { background: #ffb6d5; color: #d72660; }
        .btn-warning { background: #ffe0f0; color: #d72660; }
        .btn-warning:hover { background: #ffd6e0; color: #d72660; }
        .btn-danger { background: #ffb6b6; color: #d72660; }
        .btn-danger:hover { background: #ffb6d5; color: #d72660; }
        .btn-info { background: #ffd6e0; color: #d72660; }
        .btn-info:hover { background: #ffb6d5; color: #d72660; }
        .btn-secondary { background: #f8bbd0; color: #d72660; }
        .btn-secondary:hover { background: #ffd6e0; color: #d72660; }
        .table-bordered th, .table-bordered td { background: #fffafd; }
        .schedule-mode-selector {
            background: #fff5f8;
            border: 2px solid #ffb6d5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .schedule-mode-selector .form-check-input:checked {
            background-color: #d72660;
            border-color: #d72660;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>è‡ªå‹•æ’ç­</h2>
    <div class="mb-3 d-flex gap-2">
        <a href="/view_schedule" class="btn btn-info">æŸ¥çœ‹ç­è¡¨</a>
        <a href="/" class="btn btn-secondary">å›é¦–é </a>
    </div>
    
    <!-- æ’ç­æ¨¡å¼é¸æ“‡å€å¡Š -->
    <div class="schedule-mode-selector">
        <h5 class="mb-3">æ’ç­æ¨¡å¼é¸æ“‡</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="schedule_mode" id="monthMode" value="month" checked>
                    <label class="form-check-label" for="monthMode">
                        <strong>æ•´æœˆæ’ç­æ¨¡å¼</strong>
                    </label>
                    <small class="form-text text-muted d-block">é¸æ“‡æœˆä»½ï¼Œç³»çµ±è‡ªå‹•ç”¢ç”Ÿè©²æœˆå®Œæ•´æ’ç­</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="schedule_mode" id="customMode" value="custom">
                    <label class="form-check-label" for="customMode">
                        <strong>è‡ªè¨‚æ—¥æœŸç¯„åœ</strong>
                    </label>
                    <small class="form-text text-muted d-block">æ‰‹å‹•è¨­å®šèµ·å§‹æ—¥æœŸèˆ‡çµæŸæ—¥æœŸ</small>
                </div>
            </div>
        </div>
    </div>

    <!-- å››å‘¨è®Šå½¢å·¥æ™‚è¨­å®šå€å¡Š -->
    <div class="flexible-workweek-section mb-4">
        <div class="card">
            <div class="card-header">
                <h5>å››å‘¨è®Šå½¢å·¥æ™‚è¨­å®š</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="is_flexible_workweek" id="flexibleWorkweek" checked>
                            <label class="form-check-label" for="flexibleWorkweek">
                                å•Ÿç”¨å››å‘¨è®Šå½¢å·¥æ™‚
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="require_holiday" id="requireHoliday" checked>
                            <label class="form-check-label" for="requireHoliday">
                                æ¯äººæ¯é€±éœ€è¦ä¸€å€‹ä¾‹å‡æ—¥
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="require_rest_day" id="requireRestDay" checked>
                            <label class="form-check-label" for="requireRestDay">
                                æ¯äººæ¯é€±éœ€è¦ä¸€å€‹ä¼‘æ¯æ—¥
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label">ä¾‹å‡æ—¥è¨­å®š</label>
                        <select class="form-select" name="holiday_day" id="holidayDay">
                            <option value="1">é€±ä¸€</option>
                            <option value="2">é€±äºŒ</option>
                            <option value="3">é€±ä¸‰</option>
                            <option value="4">é€±å››</option>
                            <option value="5">é€±äº”</option>
                            <option value="6">é€±å…­</option>
                            <option value="7" selected>é€±æ—¥</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="alert alert-warning">
                            <small>
                                <strong>æ³¨æ„ï¼š</strong>å››å‘¨è®Šå½¢å·¥æ™‚ä¸‹ï¼Œæ¯äººæ¯é€±å·¥æ™‚ä¸è¶…é40å°æ™‚ï¼Œ 
                                ä¾‹å‡æ—¥èˆ‡ä¼‘æ¯æ—¥å°‡è‡ªå‹•å®‰æ’ï¼Œç¢ºä¿å“¡å·¥æ¬Šç›Šã€‚
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" action="/auto_schedule" class="mb-3">
        <!-- æ•´æœˆæ’ç­æ¨¡å¼ -->
        <div id="monthModeSection" class="row g-3 align-items-end mb-3">
            <div class="col-auto">
                <label for="month" class="form-label">é¸æ“‡æœˆä»½</label>
                <input type="month" class="form-control" id="month" name="month" value="{{ default_month }}" required>
            </div>
        </div>

        <!-- è‡ªè¨‚æ—¥æœŸç¯„åœæ¨¡å¼ -->
        <div id="customModeSection" class="row g-3 align-items-end mb-3" style="display: none;">
            <div class="col-md-4">
                <label for="start_date" class="form-label">èµ·å§‹æ—¥æœŸ</label>
                <input type="date" class="form-control" id="start_date" name="start_date" required>
            </div>
            <div class="col-md-4">
                <label for="end_date" class="form-label">çµæŸæ—¥æœŸ</label>
                <input type="date" class="form-control" id="end_date" name="end_date" required>
            </div>
            <div class="col-md-4">
                <div class="alert alert-info">
                    <small>
                        <strong>æ—¥æœŸç¯„åœï¼š</strong><span id="dateRangeInfo">è«‹é¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸ</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- æ’ç­åƒæ•¸è¨­å®š -->
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">æ¯äººæ¯æ—¥æœ€å¤šç­æ•¸</label>
                <input type="number" class="form-control" name="max_per_day" value="1" min="1" max="3">
            </div>
            <div class="col-md-2">
                <label class="form-label">é€£çºŒä¸Šç­å¤©æ•¸ä¸Šé™</label>
                <input type="number" class="form-control" name="max_consecutive" value="5" min="1" max="14">
            </div>
            <div class="col-md-2">
                <label class="form-label">æ¯æœˆç­æ•¸ä¸‹é™</label>
                <input type="number" class="form-control" name="min_per_month" value="22" min="0" max="31">
            </div>
            <div class="col-md-2">
                <label class="form-label">æ¯æœˆç­æ•¸ä¸Šé™</label>
                <input type="number" class="form-control" name="max_per_month" value="30" min="1" max="31">
            </div>
            <div class="col-md-2">
                <label class="form-label">å¤§å¤œç­é€£çºŒå¤©æ•¸ä¸Šé™</label>
                <input type="number" class="form-control" name="max_night_consecutive" value="2" min="1" max="7">
            </div>
            <div class="col-md-2">
                <label class="form-label">å¤§å¤œç­æ¯æœˆä¸Šé™</label>
                <input type="number" class="form-control" name="max_night_per_month" value="8" min="0" max="31">
            </div>
            <div class="col-md-2">
                <label class="form-label">ç¼ºäººè‡ªå‹•æ¨™è¨»</label>
                <select class="form-select" name="auto_fill_missing">
                    <option value="yes" selected>æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">ç­åˆ¥å…¬å¹³åˆ†é…</label>
                <select class="form-select" name="fair_distribution">
                    <option value="yes" selected>æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">ç‰¹æ®Šäººå“¡æ’ç­åå¥½</label>
                <select class="form-select" name="special_preference">
                    <option value="no" selected>å¦</option>
                    <option value="yes">æ˜¯</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">å‡æ—¥ On Call æ•´åˆ</label>
                <select class="form-select" name="include_oncall">
                    <option value="no" selected>å¦</option>
                    <option value="yes">æ˜¯</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">é€±ç­åˆ¥ä¸€è‡´æ€§</label>
                <select class="form-select" name="week_shift_consistency">
                    <option value="yes" selected>æ˜¯</option>
                    <option value="no">å¦</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary" id="submitBtn" onclick="startAutoScheduleWithValidation()">æ™ºèƒ½è‡ªå‹•æ’ç­</button>
                <button type="submit" class="btn btn-outline-secondary" id="basicSubmitBtn">åŸºæœ¬è‡ªå‹•æ’ç­</button>
            </div>
        </div>
    </form>
    
    <div class="alert alert-info mb-3">
        <b>æ’ç­åŸå‰‡ï¼š</b>åŒä¸€ä½å“¡å·¥å¾ä¸€å€‹ç­åˆ¥ï¼ˆå¦‚æ—©ç­ï¼‰è½‰æ›åˆ°å¦ä¸€å€‹ç­åˆ¥ï¼ˆå¦‚å°å¤œç­æˆ–å¤§å¤œç­ï¼‰ï¼Œ<br>
        <b>ä¸­é–“å¿…é ˆé–“éš”è‡³å°‘11å°æ™‚</b>ï¼ˆæ‰€æœ‰ç­åˆ¥é–“çš†é©ç”¨ï¼‰ã€‚
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthMode = document.getElementById('monthMode');
    const customMode = document.getElementById('customMode');
    const monthModeSection = document.getElementById('monthModeSection');
    const customModeSection = document.getElementById('customModeSection');
    const monthInput = document.getElementById('month');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const dateRangeInfo = document.getElementById('dateRangeInfo');
    const submitBtn = document.getElementById('submitBtn');

    // è¨­å®šé è¨­æ—¥æœŸï¼ˆä»Šå¤©é–‹å§‹ï¼Œ30å¤©å¾ŒçµæŸï¼‰
    const today = new Date();
    const endDate = new Date();
    endDate.setDate(today.getDate() + 30);
    
    startDateInput.value = today.toISOString().split('T')[0];
    endDateInput.value = endDate.toISOString().split('T')[0];
    
    updateDateRangeInfo();

    // æ’ç­æ¨¡å¼åˆ‡æ›
    function toggleScheduleMode() {
        if (monthMode.checked) {
            monthModeSection.style.display = 'flex';
            customModeSection.style.display = 'none';
            monthInput.required = true;
            startDateInput.required = false;
            endDateInput.required = false;
            submitBtn.textContent = 'ä¸€éµè‡ªå‹•æ’ç­ï¼ˆç”¢ç”Ÿæ•´æœˆï¼‰';
        } else {
            monthModeSection.style.display = 'none';
            customModeSection.style.display = 'flex';
            monthInput.required = false;
            startDateInput.required = true;
            endDateInput.required = true;
            submitBtn.textContent = 'ä¸€éµè‡ªå‹•æ’ç­ï¼ˆè‡ªè¨‚æ—¥æœŸç¯„åœï¼‰';
        }
    }

    // æ›´æ–°æ—¥æœŸç¯„åœè³‡è¨Š
    function updateDateRangeInfo() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDateInput.value && endDateInput.value) {
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            dateRangeInfo.textContent = `${diffDays} å¤©`;
        } else {
            dateRangeInfo.textContent = 'è«‹é¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸ';
        }
    }

    // äº‹ä»¶ç›£è½å™¨
    monthMode.addEventListener('change', toggleScheduleMode);
    customMode.addEventListener('change', toggleScheduleMode);
    startDateInput.addEventListener('change', updateDateRangeInfo);
    endDateInput.addEventListener('change', updateDateRangeInfo);

    // è¡¨å–®é©—è­‰
    document.querySelector('form').addEventListener('submit', function(e) {
        if (customMode.checked) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate > endDate) {
                e.preventDefault();
                alert('èµ·å§‹æ—¥æœŸä¸èƒ½å¤§æ–¼çµæŸæ—¥æœŸï¼');
                return false;
            }
            
            if (endDate - startDate > 365 * 24 * 60 * 60 * 1000) {
                e.preventDefault();
                alert('æ’ç­æ—¥æœŸç¯„åœä¸èƒ½è¶…éä¸€å¹´ï¼');
                return false;
            }
        }
    });
});

// æ™ºèƒ½è‡ªå‹•æ’ç­å‡½æ•¸ï¼ˆå¸¶é©—è­‰æ©Ÿåˆ¶ï¼‰
function startAutoScheduleWithValidation() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    const basicSubmitBtn = document.getElementById('basicSubmitBtn');
    
    // è¡¨å–®é©—è­‰
    if (!validateForm()) {
        return;
    }
    
    // ç¦ç”¨æŒ‰éˆ•
    submitBtn.disabled = true;
    basicSubmitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ™ºèƒ½æ’ç­ä¸­...';
    
    // é¡¯ç¤ºé€²åº¦æç¤º
    showScheduleProgress('é–‹å§‹æ™ºèƒ½è‡ªå‹•æ’ç­...', 'info');
    
    // æ”¶é›†è¡¨å–®è³‡æ–™
    const formData = new FormData(form);
    
    // ç™¼é€è«‹æ±‚åˆ°é©—è­‰æ’ç­API
    fetch('/auto_schedule_with_validation', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showScheduleProgress(
                `âœ… ${data.message}<br>é‡è©¦æ¬¡æ•¸ï¼š${data.retry_count}`, 
                'success'
            );
            
            // é¡¯ç¤ºé©—è­‰çµæœè©³æƒ…
            displayValidationResults(data.validation_results);
            
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 3000);
        } else {
            showScheduleProgress(
                `âŒ ${data.message}<br>${data.retry_count ? `å˜—è©¦æ¬¡æ•¸ï¼š${data.retry_count}` : ''}`, 
                'danger'
            );
            
            if (data.validation_results) {
                displayValidationResults(data.validation_results);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showScheduleProgress('âŒ æ’ç­éç¨‹ç™¼ç”ŸéŒ¯èª¤', 'danger');
    })
    .finally(() => {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        setTimeout(() => {
            submitBtn.disabled = false;
            basicSubmitBtn.disabled = false;
            submitBtn.innerHTML = 'æ™ºèƒ½è‡ªå‹•æ’ç­';
        }, 3000);
    });
}

// é¡¯ç¤ºæ’ç­é€²åº¦è¨Šæ¯
function showScheduleProgress(message, type) {
    // ç§»é™¤ç¾æœ‰çš„é€²åº¦æç¤º
    const existingAlert = document.querySelector('.schedule-progress-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // å‰µå»ºæ–°çš„é€²åº¦æç¤º
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} schedule-progress-alert mt-3`;
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="me-3">
                ${type === 'info' ? '<div class="spinner-border spinner-border-sm"></div>' : ''}
            </div>
            <div>${message}</div>
        </div>
    `;
    
    // æ’å…¥åˆ°è¡¨å–®å¾Œé¢
    const form = document.querySelector('form');
    form.parentNode.insertBefore(alertDiv, form.nextSibling);
}

// é¡¯ç¤ºé©—è­‰çµæœè©³æƒ…
function displayValidationResults(results) {
    const existingResults = document.querySelector('.validation-results');
    if (existingResults) {
        existingResults.remove();
    }
    
    const resultsDiv = document.createElement('div');
    resultsDiv.className = 'validation-results mt-3';
    
    let html = '<div class="card"><div class="card-header"><h5>ğŸ” æ’ç­é©—è­‰çµæœ</h5></div><div class="card-body">';
    
    // å¤§å¤œç­é å…ˆåˆ†é…æª¢æŸ¥
    html += `
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>å¤§å¤œç­é å…ˆåˆ†é…ï¼š</strong>
                <span class="badge ${results.night_shift_priority.passed ? 'bg-success' : 'bg-danger'}">
                    ${results.night_shift_priority.passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
                </span>
            </div>
            <div class="col-md-8">
                ${results.night_shift_priority.details.length > 0 ? 
                    '<ul class="mb-0">' + results.night_shift_priority.details.map(d => `<li class="text-danger small">${d}</li>`).join('') + '</ul>' : 
                    '<small class="text-muted">æ‰€æœ‰é å…ˆåˆ†é…éƒ½å·²æ­£ç¢ºåŸ·è¡Œ</small>'
                }
            </div>
        </div>
    `;
    
    // ä¼‘æ¯æ—¥å’Œä¾‹å‡æ—¥æª¢æŸ¥
    html += `
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>ä¼‘æ¯æ—¥/ä¾‹å‡æ—¥å®‰æ’ï¼š</strong>
                <span class="badge ${results.rest_days_arrangement.passed ? 'bg-success' : 'bg-danger'}">
                    ${results.rest_days_arrangement.passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
                </span>
            </div>
            <div class="col-md-8">
                ${results.rest_days_arrangement.details.length > 0 ? 
                    '<ul class="mb-0">' + results.rest_days_arrangement.details.map(d => `<li class="text-danger small">${d}</li>`).join('') + '</ul>' : 
                    '<small class="text-muted">æ‰€æœ‰å“¡å·¥éƒ½æœ‰é©ç•¶çš„ä¼‘æ¯æ—¥å’Œä¾‹å‡æ—¥</small>'
                }
            </div>
        </div>
    `;
    
    // é€±ç­åˆ¥ä¸€è‡´æ€§æª¢æŸ¥
    html += `
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>é€±ç­åˆ¥ä¸€è‡´æ€§ï¼š</strong>
                <span class="badge ${results.weekly_shift_consistency.passed ? 'bg-success' : 'bg-danger'}">
                    ${results.weekly_shift_consistency.passed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
                </span>
            </div>
            <div class="col-md-8">
                ${results.weekly_shift_consistency.details.length > 0 ? 
                    '<ul class="mb-0">' + results.weekly_shift_consistency.details.map(d => `<li class="text-danger small">${d}</li>`).join('') + '</ul>' : 
                    '<small class="text-muted">æ‰€æœ‰å“¡å·¥æ¯é€±æœ€å¤šå®‰æ’2ç¨®ç­åˆ¥</small>'
                }
            </div>
        </div>
    `;
    
    html += '</div></div>';
    resultsDiv.innerHTML = html;
    
    // æ’å…¥åˆ°é€²åº¦æç¤ºå¾Œé¢
    const progressAlert = document.querySelector('.schedule-progress-alert');
    if (progressAlert) {
        progressAlert.parentNode.insertBefore(resultsDiv, progressAlert.nextSibling);
    }
}

// è¡¨å–®é©—è­‰å‡½æ•¸
function validateForm() {
    const monthMode = document.getElementById('monthMode');
    const customMode = document.getElementById('customMode');
    
    if (customMode && customMode.checked) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (!startDate || !endDate) {
            alert('è«‹é¸æ“‡èµ·å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸï¼');
            return false;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            alert('èµ·å§‹æ—¥æœŸä¸èƒ½å¤§æ–¼çµæŸæ—¥æœŸï¼');
            return false;
        }
    } else if (monthMode && monthMode.checked) {
        const month = document.getElementById('month').value;
        if (!month) {
            alert('è«‹é¸æ“‡æ’ç­æœˆä»½ï¼');
            return false;
        }
    }
    
    return true;
}
</script>
</body>
</html> 