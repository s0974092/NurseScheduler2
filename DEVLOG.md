# 護理人員排班系統 開發日誌

## 2025-01-02 員工橫式排班表功能升級

### 📊 員工橫式排班表介面優化
- **導航優化**：
  - 將「回上一頁」按鈕移至頁面上方
  - 新增「回首頁」按鈕，提升使用者導航體驗
  - 按鈕佈局採用左右分佈設計，視覺平衡更佳

### 🔧 智能CSV匯出功能
- **跳出視窗設計**：
  - 使用 Bootstrap Modal 建立專業設定介面
  - 點擊「匯出 CSV」觸發設定視窗，而非直接下載
  - 分組式設定介面，操作邏輯清晰直觀

- **文字替代代碼系統**：
  - **班別替代**：早班、小夜班、大夜班可設定簡短代碼（如 D、E、N）
  - **休假替代**：例假日、休息日、空白可自訂代碼（如 H、R、-）
  - **自訂班別**：支援任意班別名稱的替代設定
  - **選擇性替代**：留空的欄位不進行替代，保持彈性

### 🎨 使用者體驗升級
- **視覺設計**：
  - 新增 Bootstrap Icons 圖示支援
  - 設定分組使用視覺區塊，提升可讀性
  - 按鈕樣式統一，符合系統設計語言

- **智能處理**：
  - 自動判斷文字類型並套用對應替代規則
  - 檔名智能標示：使用替代代碼時自動加上「_已替代」後綴
  - UTF-8 BOM 編碼確保中文相容性

### 🔧 技術實作細節
- **前端架構**：
  - Modal 視窗與表單整合
  - JavaScript 表單提交處理
  - 響應式設計適配各種螢幕尺寸

- **後端邏輯**：
  - `apply_replacement()` 函數處理文字替代邏輯
  - 支援空白、None 值的安全處理
  - 動態檔名生成機制

### 📋 功能價值
- **提升效率**：一鍵匯出可直接用於其他系統的格式化資料
- **降低錯誤**：自動化替代減少手動轉換的人為錯誤
- **增強彈性**：使用者可根據需求自訂匯出格式
- **改善體驗**：直觀的設定介面讓功能更易使用

---

## 2025-01-02 On Call 管理系統完成

### 📞 星期天 On Call 管理功能
- **系統目標**：建立只針對星期天的 On Call 人員管理系統
- **核心功能**：
  - 手動新增 On Call 設定（僅限星期天）
  - 批次自動分配星期天 On Call 人員
  - 日期範圍查詢與人員篩選功能
  - 編輯/刪除 On Call 設定的完整 CRUD 操作

### 🔧 技術實作
- **前端界面**：
  - 星期天限制驗證（JavaScript + 後端雙重驗證）
  - 日期範圍查詢表單（起始日期-結束日期）
  - 人員篩選下拉選單
  - 快捷按鈕（本月、清除）
  - Bootstrap Modal 編輯視窗
  - Font Awesome 圖示支援

- **後端邏輯**：
  - `get_weekend_dates()` 函數修改為只返回星期天
  - 新增 `/delete_oncall` 路由處理刪除功能
  - 雙模式查詢支援（月份模式/日期範圍模式）
  - 人員篩選整合到 SQL 查詢
  - 星期天驗證機制

- **資料庫結構**：
  - `oncall_schedule` 資料表：date, staff_id, status, created_at
  - 支援 oncall（主要）、backup（備援）、off（休息）三種狀態

### 🎨 使用者介面
- **粉紅主題**：統一使用系統粉紅色調
- **響應式設計**：支援不同螢幕尺寸
- **視覺化標識**：星期天以藍色背景特別標示
- **操作反饋**：完整的成功/錯誤訊息提示

### 📊 查詢與分析功能
- **彈性查詢**：
  - 日期範圍查詢（最多一年）
  - 特定人員篩選
  - 跨月份查詢支援
- **統計資訊**：顯示查詢期間星期天總數
- **友善提示**：無資料時顯示適當訊息

### 🔐 權限控制
- 需要登入且具備管理員權限
- 所有 CRUD 操作都有權限驗證
- 安全的表單 CSRF 保護

### 📝 功能特色
1. **精確定位**：只處理星期天，避免不必要的複雜性
2. **批次管理**：可一次為整月星期天分配 On Call 人員
3. **靈活查詢**：支援時間範圍和人員的組合查詢
4. **即時編輯**：Modal 視窗內完成所有編輯操作
5. **資料完整性**：前後端雙重驗證確保資料正確性

---

## 一、原始專案開發規劃（MVP）

### 1. 產品目標
- 建立一套簡易、可擴充的護理人員排班系統，協助醫療單位有效管理護理人力與班表。

### 2. 主要功能
- **人員管理**：新增、編輯、刪除、查詢護理人員（含病房分組、批次上傳/下載）
- **班別設定**：新增、編輯、刪除、查詢班別（含病房、上班時間、所需人數、批次上傳/下載）
- **自動排班**：一鍵產生排班表（根據規則與人員資料，MVP 先用隨機分配，後續支援進階規則）
- **班表查詢**：依條件查詢班表、支援搜尋、匯出
- **班表分析**：樞紐分析表格，讓使用者自由分析班表內容
- **資料儲存**：SQLite 資料庫

### 3. 技術選型
- 前端：Flask + Bootstrap + PivotTable.js
- 後端：Python
- 資料庫：SQLite
- 匯出：CSV

---

## 二、目前已完成的功能

- 人員管理（CRUD、病房分組、批次上傳/下載）
- 班別設定（CRUD、病房欄位、批次上傳/下載）
- 自動排班（支援進階規則：每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註）
- 班表查詢（多條件搜尋、查詢結果匯出CSV）
- 班表分析（PivotTable.js 樞紐分析，支援拖曳分析）
- 所有資料皆儲存於 SQLite，資料結構可擴充

---

## 三、下一階段建議執行步驟

### 1. **自動排班進階優化**
   - 支援「月」排班（目前為週）
   - 增加更多排班規則（如排休、夜班限制、特殊人員需求）
   - 排班結果可手動微調

### 2. **權限與帳號管理**
   - 區分主管與一般護理人員權限（主管可編輯，護理人員僅查詢）
   - 登入/登出功能

### 3. **使用者體驗優化**
   - 介面美化、操作流程優化
   - 增加操作提示、錯誤訊息

### 4. **資料備份/還原**
   - 支援資料備份與還原功能

### 5. **進階報表與匯出**
   - 支援匯出 Excel
   - 匯出排班統計報表（如每人班數、每班人力分布）

### 6. **API/雲端化（選擇性）**
   - 提供 API 介面，方便未來串接其他系統
   - 部署到雲端，支援多用戶協作

---

## 四、你可以選擇的下一步

- 進行「月排班」與進階規則設計
- 權限管理與登入功能
- 介面美化與使用者體驗優化
- 進階報表與匯出
- 其他你有興趣或需求的功能

## 2025-06-xx
- 新增「月曆檢視」功能，採用 FullCalendar.js 呈現班表，支援月份切換與班別資訊提示。
- 月曆檢視頁面新增「月份選擇器」，可快速切換不同月份班表。
- 自動排班後，系統自動導向該月份的月曆檢視。
- 班表查詢頁面下方新增「本月班數統計」與警示（低於22班或高於30班以紅色顯示）。
- 介面與操作體驗優化建議：UI美化、操作提示、響應式設計。
- 補充未來建議：權限管理、手動微調、資料備份/還原、API串接、雲端化。

## 2025-06-xx 專案藍圖與行動計畫更新

### 一、現有基礎（已完成）
- 人員/班別管理（批次上傳/下載、分組、CRUD）
- 自動排班（含月排班、進階規則）
- 班表查詢/分析（多條件、CSV、月曆、PivotTable）
- 直覺化 UI（Bootstrap）

### 二、重點強化與新功能規劃
1. 法規校驗與違規預警
   - 內建《勞基法》與醫院內規自動校驗（如11小時間隔、週工時、花花班、夜班上限、加班偵測）
   - 違規即時警示、禁止輸出或自動重排
2. 偏好與例外情境處理
   - 員工偏好登記（班別、時段、固定班、特定日排除）
   - 特殊政策（如夜班間隔、培訓日排除等）
3. 手動微調與月曆互動
   - FullCalendar 拖曳修改班別
   - 異動即時儲存、異動紀錄保存（稽核用）
4. 權限分級與操作分流
   - 員工：查詢/下載個人班表
   - 主管：排班、審核、批次上傳
   - 管理員：全院統計、規則設定、資料備份
5. 報表與視覺化分析
   - 加班、夜班分布、合規分析、出勤效率等多元報表
   - 視覺化（Chart.js/ECharts）
6. 資料備份與復原
   - 每日自動備份（JSON/SQL）
   - 一鍵還原、版本切換、跨院匯出
7. API 與雲端支援
   - RESTful API（串接HR/出勤/薪資等）
   - 標準登入驗證（OAuth2/JWT）
   - 雲端部署（Heroku/AWS/Azure）

### 三、下一階段行動建議（優先順序）
| 階段            | 工作項目                      |
| ------------- | ------------------------- |
| 1️⃣ 權限管理與登入功能 | 實作登入、角色權限分級、UI 分流         |
| 2️⃣ 排班規則彈性化   | 夜班上限、輪班間隔、自訂規則介面          |
| 3️⃣ 月曆互動微調    | FullCalendar 拖曳修改、即時儲存    |
| 4️⃣ UI/UX 美化  | 響應式設計、錯誤提示與操作導引優化         |
| 5️⃣ 備份還原模組    | JSON 或 SQL 匯出/匯入按鈕與每日備份計畫 |
| 6️⃣ 報表擴充與 API | 建立統計報表介面與初步 API 架構草圖      |

---

## 2025-05-xx
- MVP功能完成：人員管理、班別設定、班表查詢、班表分析、自動排班（含進階規則）、CSV匯入匯出。
- 支援依病房分組排班、進階排班規則（每日最多一班、連續上班天數、每月班數上下限、公平分配、缺人自動標註）。
- 首頁、班表查詢、班表分析（PivotTable.js）等主要頁面完成。

## 2025/xx/xx
- 完成班表分析頁面美化：
  - 加入活力綠主題卡片、明顯標題、說明文字。
  - 新增「匯出CSV」按鈕，可將分析結果匯出。
  - PivotTable.js 介面現代化，支援自由拖曳分析。

## 下一步建議
- 進階自動排班（夜班限制、特殊需求、手動微調）
- 權限與帳號管理（主管/一般人員、登入登出）
- 介面美化、操作提示、資料備份/還原、進階報表與匯出、API/雲端化 

## 2025-06-xx 介面美化與功能優化
- 全站主色調改為淺粉紅，首頁及所有子頁面背景、標題、卡片、按鈕皆統一色系。
- 員工橫式排班表優化：
  - 日期下方新增顯示星期（一二三四五六日）。
  - 早班、小夜班、大夜班以不同底色顯示。
- 各頁按鈕與導覽動線優化：
  - 「員工橫式排班表」按鈕移至班表查詢頁「月曆檢視」右側。
  - 各頁「回首頁」「回上一頁」按鈕位置調整，動線更直覺。
- staff頁面「批次上傳」「範本下載」按鈕版面與shift頁一致，並支援點擊自動上傳。
- staff頁面新增「篩選搜尋」功能，可依員工編號、姓名、職稱、病房即時過濾。
- 其他UI一致性優化與細節調整。 

## 2025-06-xx 下一步開發計畫

### 1️⃣ 權限管理與登入功能
- 目標：區分主管與一般護理人員權限，保障資料安全。
- 內容：
  - 實作登入/登出功能。
  - 依角色分流介面（主管可編輯，護理人員僅查詢）。
  - 介面右上角顯示登入狀態。

### 2️⃣ 排班規則彈性化
- 目標：讓排班更貼合實務需求與法規。
- 內容：
  - 夜班上限、輪班間隔、自訂規則介面。
  - 支援員工偏好、特殊排班需求（如特定日排除、固定班等）。

### 3️⃣ 月曆互動微調
- 目標：提升班表調整的便利性。
- 內容：
  - FullCalendar 拖曳修改班別。
  - 異動即時儲存、異動紀錄保存（稽核用）。

### 4️⃣ UI/UX 美化與操作提示
- 響應式設計，手機/平板友善。
- 增加操作提示、錯誤訊息、流程引導。

### 5️⃣ 資料備份與還原
- 支援資料備份（JSON/SQL）、一鍵還原、版本切換。

### 6️⃣ 進階報表與匯出
- 支援匯出 Excel、加班/夜班分布/合規分析等報表。

### 7️⃣ API/雲端化（選擇性）
- RESTful API、雲端部署。

---

## 權限管理開發計畫（2025-06-xx）

### 1. 需求規劃
- 角色區分：
  - 主管（Admin/Manager）：可新增、編輯、刪除人員與班別、執行自動排班、查詢與匯出所有班表。
  - 一般護理人員（Staff）：僅能查詢自己的班表與基本資訊，不可編輯資料。
- 登入/登出機制：
  - 使用帳號密碼登入。
  - 登入後顯示使用者名稱與角色。
  - 支援登出。
- 權限分流：
  - 依角色顯示不同功能選單與頁面。
  - 未授權操作自動導向登入或顯示權限不足提示。

### 2. 技術實作建議
- 帳號資料表設計（user）：user_id, username, password_hash, role（admin/staff）, 相關人員ID（如 staff_id）
- 密碼加密：使用 werkzeug.security hash 工具。
- Session 管理：Flask 內建 session 或 Flask-Login。
- 頁面保護：用 decorator 檢查登入與角色權限。

### 3. 頁面與流程
- 登入頁：/login
- 登出功能：/logout
- 註冊頁（可選）：僅限管理員新增帳號
- 首頁/功能頁：依登入狀態與角色顯示不同選單
- 權限不足提示頁：/unauthorized

### 4. 實作步驟建議
1. 新增 user 資料表，並建立一組管理員帳號。
2. 實作登入/登出功能，登入後將 user_id、role 存入 session。
3. 各頁加上權限檢查（如需 admin 權限才可進入）。
4. 首頁與功能頁依角色顯示不同選單。
5. 測試：未登入、不同角色登入時的功能限制。

### 5. 延伸功能（可選）
- 密碼重設
- 帳號啟用/停用
- 操作紀錄（Log） 

## 2025-06-xx 權限管理與使用者管理功能開發進度
- 全站登入保護，未登入自動導向登入頁。
- 依登入者角色（管理員/護理人員）顯示不同功能選單。
- 首頁右上角顯示登入者名稱與登出按鈕。
- 管理員專用「使用者管理」頁面：
  - 可新增、編輯、刪除使用者，設定角色與對應護理人員。
  - 支援批次上傳/下載使用者資料（CSV）。
- 月曆檢視頁面新增「員工姓名、病房、班別」篩選查詢功能。
- 介面與操作流程持續優化。 

## 2025-06-xx 重大功能與介面優化
- 新增 schedule_log（班表異動紀錄）資料表，所有班表編輯/刪除自動寫入異動紀錄。
- 班表查詢、月曆檢視頁新增「編輯」按鈕，管理員可直接編輯/刪除班表。
- 編輯班表彈窗（modal）優化：
  - 員工編號欄位支援 select2，可搜尋員工編號或姓名。
  - 權限控管，僅管理員可操作。
  - 狀態欄位改為下拉選單（正常、請假、調班、加班、缺勤、其他）。
- schedule_log 頁面可查詢所有異動紀錄，顯示異動前後內容。
- 修正 select2 在 modal 內無法搜尋的問題，改為每次 modal 彈出時初始化。
- 全站介面一致性優化，移除除錯欄位，保留乾淨操作體驗。
- README 同步更新，並已 commit/push 至 GitHub。 

---

## 2025-06-xx 特定規則功能開發完成

### 🎯 **新增核心功能**

#### 1. **特定人員排班偏好設定**
- **資料庫擴充**：新增 `staff_preference` 資料表
  - 支援單一班別偏好（指定人員只值勤特定班別）
  - 支援雙班別偏好（指定人員值勤兩種班別）
  - 週次模式：交替週次（奇數週班別1，偶數週班別2）、連續週次（前兩週班別1，後兩週班別2）
- **管理介面**：新增「排班偏好設定」頁面
  - 直覺化表單設計，支援動態顯示/隱藏欄位
  - 現有偏好設定列表與編輯功能
  - 批次管理與刪除功能

#### 2. **假日 On Call 管理系統**
- **資料庫擴充**：新增 `oncall_schedule` 資料表
  - 支援主要 On Call、備援 On Call、休息狀態
  - 與班表資料整合顯示
- **管理介面**：新增「假日 On Call 管理」頁面
  - 手動設定 On Call 人員與狀態
  - 批次自動分配週末 On Call
  - 月曆檢視，清楚顯示每日 On Call 安排
  - 週末日期自動高亮顯示

#### 3. **自動排班邏輯重大升級**
- **排班偏好整合**：
  - 自動檢查人員排班偏好設定
  - 支援單一班別限制
  - 支援雙班別週次模式自動分配
  - 保持原有規則（11小時間隔、連續天數限制等）
- **週次計算**：自動計算日期屬於第幾週，支援週次模式排班
- **資料完整性**：只刪除指定月份的班表，保留其他月份資料

#### 4. **介面整合與優化**
- **首頁更新**：新增「假日 On Call 管理」功能連結
- **人員管理頁面**：新增「排班偏好設定」按鈕
- **班表查詢頁面**：新增 On Call 狀態欄位顯示
- **自動排班頁面**：新增「假日 On Call 整合」選項
- **資料查詢優化**：班表查詢整合 On Call 資訊

### 🔧 **技術實作細節**

#### 資料庫結構擴充
```sql
-- 人員排班偏好設定
CREATE TABLE staff_preference (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    staff_id TEXT NOT NULL,
    month TEXT NOT NULL,  -- yyyy-mm 格式
    preference_type TEXT NOT NULL,  -- 'single' 或 'dual'
    shift_id_1 TEXT,  -- 主要班別
    shift_id_2 TEXT,  -- 次要班別（雙班別時使用）
    week_pattern TEXT,  -- 'alternate' 或 'consecutive'
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (staff_id) REFERENCES staff (staff_id),
    FOREIGN KEY (shift_id_1) REFERENCES shift (shift_id),
    FOREIGN KEY (shift_id_2) REFERENCES shift (shift_id),
    UNIQUE(staff_id, month)
);

-- 假日 On Call 排班
CREATE TABLE oncall_schedule (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date TEXT NOT NULL,
    staff_id TEXT NOT NULL,
    status TEXT DEFAULT 'oncall',  -- 'oncall', 'backup', 'off'
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (staff_id) REFERENCES staff (staff_id),
    UNIQUE(date, staff_id)
);
```

#### 新增路由功能
- `/staff_preference` - 排班偏好設定頁面
- `/add_staff_preference` - 新增/編輯排班偏好
- `/delete_staff_preference` - 刪除排班偏好
- `/oncall_manage` - 假日 On Call 管理頁面
- `/add_oncall` - 新增 On Call 設定
- `/batch_oncall` - 批次設定 On Call

#### 輔助函數
- `generate_calendar_days()` - 產生月曆資料
- `get_weekend_dates()` - 取得週末日期列表

### 📊 **功能特色**

#### 排班偏好系統
- **靈活性**：支援單一/雙班別設定
- **週次模式**：交替週次與連續週次兩種模式
- **月份管理**：每個月可設定不同的偏好
- **衝突檢查**：自動檢查班別間隔與連續天數限制

#### On Call 管理系統
- **狀態管理**：主要、備援、休息三種狀態
- **批次處理**：自動分配週末 On Call
- **視覺化**：月曆檢視，週末高亮
- **整合顯示**：班表查詢中顯示 On Call 狀態

#### 自動排班增強
- **偏好優先**：優先考慮人員排班偏好
- **週次計算**：自動計算週次並套用模式
- **規則保持**：維持原有排班規則完整性
- **資料安全**：只處理指定月份，不影響其他資料

### 🎨 **使用者體驗優化**

#### 介面一致性
- 保持淺粉紅主題色彩
- 統一的按鈕樣式與佈局
- 直覺的導覽動線

#### 操作便利性
- 動態表單欄位顯示/隱藏
- 批次處理功能
- 即時篩選與搜尋

#### 視覺化呈現
- 月曆檢視 On Call 安排
- 狀態標籤清楚顯示
- 週末日期特殊標記

### 🚀 **下一步發展建議**

#### 短期優化（1-2週）
1. **On Call 與排班整合**：自動排班時考慮 On Call 狀態
2. **偏好衝突檢查**：檢查多個偏好設定是否有衝突
3. **報表功能**：新增 On Call 統計報表
4. **通知功能**：On Call 提醒通知

#### 中期發展（1-2個月）
1. **進階偏好設定**：支援更複雜的排班模式
2. **歷史資料分析**：分析排班偏好效果
3. **自動化建議**：基於歷史資料的排班建議
4. **行動裝置優化**：響應式設計完善

#### 長期規劃（3-6個月）
1. **AI 輔助排班**：機器學習優化排班結果
2. **多院區支援**：支援多個醫療院區
3. **API 整合**：與其他系統整合
4. **雲端部署**：支援雲端服務

### 📈 **專案里程碑**

✅ **已完成**
- 特定人員排班偏好設定
- 假日 On Call 管理系統
- 自動排班邏輯升級
- 介面整合與優化

🔄 **進行中**
- 功能測試與除錯
- 使用者回饋收集
- 文件完善

⏳ **待開發**
- On Call 與排班深度整合
- 進階報表功能
- 行動裝置優化

---

**開發團隊**：護理人員排班系統開發小組  
**完成日期**：2025-06-xx  
**版本**：v2.0.0  
**狀態**：功能開發完成，進入測試階段 

---

## 2025-06-xx 介面佈局一致性優化

### 🎯 **按鈕佈局統一調整**

#### 1. **按鈕位置標準化**
- **目標**：統一所有頁面的導覽按鈕佈局，提升使用者體驗一致性
- **調整頁面**：
  - `shift.html`（班別設定）
  - `oncall_manage.html`（假日 On Call 管理）
  - `staff_preference.html`（排班偏好設定）
  - `schedule.html`（自動排班）

#### 2. **具體調整內容**

##### **班別設定頁面（shift.html）**
- 將「回首頁」按鈕從頁面底部移動到與「範本下載」「批次上傳」按鈕同一區域
- 使用 `d-flex gap-2` 保持按鈕間距一致

##### **假日 On Call 管理頁面（oncall_manage.html）**
- 將「回首頁」「回人員管理」按鈕從頁面底部移動到標題下方
- 與 `staff.html` 的佈局邏輯保持一致

##### **排班偏好設定頁面（staff_preference.html）**
- 將「回人員管理」「回首頁」按鈕從頁面底部移動到標題下方
- 保持與其他頁面一致的導覽動線

##### **自動排班頁面（schedule.html）**
- 將「查看班表」「回首頁」按鈕從頁面底部移動到標題下方
- 統一按鈕佈局與其他功能頁面

#### 3. **佈局邏輯統一**
- **按鈕區域**：所有功能頁面的導覽按鈕統一放置在標題下方
- **間距設計**：使用 `mb-3 d-flex gap-2` 保持一致的視覺間距
- **按鈕順序**：依功能重要性與使用頻率安排按鈕順序
- **視覺一致性**：保持淺粉紅主題色彩與按鈕樣式統一

#### 4. **使用者體驗改善**
- **操作便利性**：導覽按鈕位置統一，減少使用者學習成本
- **視覺一致性**：所有頁面佈局邏輯一致，提升專業感
- **導覽效率**：重要功能按鈕位置固定，提升操作效率

### 🔧 **技術實作細節**

#### 佈局模式
```html
<!-- 統一的按鈕佈局模式 -->
<div class="mb-3 d-flex gap-2">
    <a href="/primary_function" class="btn btn-primary">主要功能</a>
    <a href="/secondary_function" class="btn btn-info">次要功能</a>
    <a href="/" class="btn btn-secondary">回首頁</a>
</div>
```

#### 調整原則
1. **功能優先級**：主要功能按鈕優先顯示
2. **導覽邏輯**：回首頁按鈕統一放置
3. **視覺平衡**：按鈕數量與大小保持平衡
4. **響應式設計**：保持在不同螢幕尺寸下的可用性

### 📊 **影響範圍**

#### 已調整頁面
- ✅ `shift.html` - 班別設定
- ✅ `oncall_manage.html` - 假日 On Call 管理  
- ✅ `staff_preference.html` - 排班偏好設定
- ✅ `schedule.html` - 自動排班

#### 參考標準
- `staff.html` - 人員管理（作為佈局標準參考）

### 🎨 **設計原則**

#### 一致性原則
- 所有功能頁面採用相同的按鈕佈局邏輯
- 保持視覺元素的一致性與專業感

#### 可用性原則
- 重要功能按鈕位置固定且容易找到
- 減少使用者在不同頁面間的操作學習成本

#### 美觀性原則
- 保持淺粉紅主題色彩統一
- 按鈕間距與大小保持視覺平衡

### 🚀 **後續優化建議**

#### 短期優化（1週內）
1. **其他頁面檢查**：確認所有功能頁面都已統一佈局
2. **響應式測試**：在不同螢幕尺寸下測試按鈕佈局
3. **使用者測試**：收集使用者對新佈局的回饋

#### 中期發展（1個月內）
1. **進階導覽**：考慮新增麵包屑導覽
2. **快捷鍵支援**：為常用功能新增鍵盤快捷鍵
3. **個人化設定**：允許使用者自訂常用功能按鈕

#### 長期規劃（3個月內）
1. **智慧導覽**：基於使用習慣的智慧按鈕排序
2. **主題切換**：支援多種視覺主題
3. **無障礙優化**：提升無障礙使用體驗

### 📈 **專案里程碑**

✅ **已完成**
- 班別設定頁面按鈕佈局調整
- 假日 On Call 管理頁面按鈕佈局調整
- 排班偏好設定頁面按鈕佈局調整
- 自動排班頁面按鈕佈局調整

🔄 **進行中**
- 其他頁面佈局一致性檢查
- 響應式設計測試

⏳ **待開發**
- 進階導覽功能
- 個人化設定選項

---

**開發團隊**：護理人員排班系統開發小組  
**完成日期**：2025-06-xx  
**版本**：v2.0.1  
**狀態**：介面佈局優化完成，進入測試階段 

---

## 2025-06-xx 四周變形工時與每日需求人數功能重大擴充

### 🎯 **核心功能新增**

#### 1. **四周變形工時管理系統**
- **資料庫擴充**：新增 `work_schedule_config` 資料表
  - 支援每月四周變形工時設定
  - 預設啟用四周變形工時（每人每週工時不超過40小時）
  - 可自訂例假日（預設週日，可調整為其他星期）
  - 支援例假日與休息日自動安排
- **排班邏輯升級**：
  - 自動檢查週工時是否超過40小時
  - 每人每週自動安排例假日與休息日
  - 例假日與休息日不安排班別
  - 工時統計與警示功能

#### 2. **班別每日需求人數設定**
- **資料庫擴充**：新增 `shift_daily_requirements` 資料表
  - 支援每個班別在週一到週日的不同需求人數
  - 保留原有「所需人數」作為預設值
  - 向後相容現有資料
- **介面功能**：
  - 班別設定頁面新增每日需求人數表格
  - 支援「複製到所有天數」功能
  - 支援「重置為預設值」功能
  - 直覺化的週一到週日設定介面

#### 3. **週工時統計與警示系統**
- **資料庫擴充**：新增 `weekly_work_stats` 資料表
  - 記錄每人每週的工時統計
  - 追蹤例假日、休息日、工作天數
  - 支援工時超限與不足警示
- **統計頁面**：
  - 新增「週工時統計」專頁
  - 顏色編碼顯示工時狀態（紅色超限、橘色不足、綠色正常）
  - 顯示四周變形工時設定狀態
  - 警示缺少例假日或休息日

### 🔧 **技術實作細節**

#### 資料庫結構擴充
```sql
-- 四周變形工時設定表
CREATE TABLE work_schedule_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    month TEXT NOT NULL,  -- yyyy-mm 格式
    is_flexible_workweek BOOLEAN DEFAULT 1,  -- 預設啟用四周變形工時
    require_holiday BOOLEAN DEFAULT 1,  -- 每人每週是否需要例假日
    require_rest_day BOOLEAN DEFAULT 1,  -- 每人每週是否需要休息日
    holiday_day INTEGER DEFAULT 7,  -- 例假日：1=週一, 2=週二, ..., 7=週日
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(month)
);

-- 班別每日需求人數表
CREATE TABLE shift_daily_requirements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    shift_id TEXT NOT NULL,
    day_of_week INTEGER NOT NULL,  -- 1=週一, 2=週二, ..., 7=週日
    required_count INTEGER NOT NULL DEFAULT 1,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (shift_id) REFERENCES shift (shift_id),
    UNIQUE(shift_id, day_of_week)
);

-- 個人週工時統計表
CREATE TABLE weekly_work_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    staff_id TEXT NOT NULL,
    month TEXT NOT NULL,  -- yyyy-mm 格式
    week_number INTEGER NOT NULL,  -- 1-4 週
    total_hours INTEGER DEFAULT 0,  -- 該週總工時
    holiday_count INTEGER DEFAULT 0,  -- 例假日天數
    rest_day_count INTEGER DEFAULT 0,  -- 休息日天數
    work_days INTEGER DEFAULT 0,  -- 工作天數
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (staff_id) REFERENCES staff (staff_id),
    UNIQUE(staff_id, month, week_number)
);
```

#### 新增路由功能
- `/weekly_stats` - 週工時統計頁面
- 修改 `/add_shift` - 支援每日需求人數設定
- 重構 `/auto_schedule` - 支援四周變形工時與每日需求人數

#### 資料遷移功能
- `migrate_existing_data()` - 自動遷移現有資料到新結構
- 將現有班別的 `required_count` 複製到每日需求表
- 為現有月份建立預設的四周變形工時設定

### 📊 **功能特色**

#### 四周變形工時系統
- **法規合規**：符合《勞基法》四周變形工時規定
- **彈性設定**：可選擇性啟用/停用，可自訂例假日
- **自動安排**：系統自動安排例假日與休息日
- **工時控制**：每人每週工時不超過40小時

#### 每日需求人數系統
- **彈性配置**：可為不同星期設定不同人力需求
- **操作便利**：複製與重置功能，減少重複設定
- **向後相容**：保留原有功能，不影響現有資料
- **視覺化介面**：清楚的週一到週日設定表格

#### 週工時統計系統
- **即時統計**：排班完成後自動計算週工時
- **視覺警示**：顏色編碼顯示工時狀態
- **詳細資訊**：顯示工作天數、例假日、休息日統計
- **設定顯示**：顯示當月四周變形工時設定

### 🎨 **使用者體驗優化**

#### 介面一致性
- 保持淺粉紅主題色彩
- 統一的按鈕樣式與佈局
- 直覺的導覽動線

#### 操作便利性
- 一鍵複製每日需求設定
- 自動重置為預設值
- 清楚的警示與說明

#### 視覺化呈現
- 顏色編碼的工時狀態
- 清楚的統計表格
- 詳細的設定說明

### 🚀 **下一步發展建議**

#### 短期優化（1-2週）
1. **工時調整**：允許自訂週工時上限（目前固定40小時）
2. **例外處理**：支援特殊情況的工時調整
3. **報表功能**：新增工時統計報表匯出
4. **通知功能**：工時超限自動通知

#### 中期發展（1-2個月）
1. **進階工時規則**：支援更複雜的工時計算規則
2. **歷史分析**：分析工時趨勢與效率
3. **自動化建議**：基於工時統計的排班建議
4. **行動裝置優化**：響應式設計完善

#### 長期規劃（3-6個月）
1. **AI 工時優化**：機器學習優化工時分配
2. **多院區支援**：支援多個醫療院區的工時管理
3. **API 整合**：與其他系統整合工時資料
4. **雲端部署**：支援雲端服務

### 📈 **專案里程碑**

✅ **已完成**
- 四周變形工時管理系統
- 班別每日需求人數設定
- 週工時統計與警示系統
- 資料庫結構擴充與遷移
- 介面整合與優化

🔄 **進行中**
- 功能測試與除錯
- 使用者回饋收集
- 文件完善

⏳ **待開發**
- 工時調整彈性化
- 進階報表功能
- 行動裝置優化

---

**開發團隊**：護理人員排班系統開發小組  
**完成日期**：2025-06-xx  
**版本**：v2.1.0  
**狀態**：四周變形工時功能開發完成，進入測試階段 

## 2024-06-XX 自動排班邏輯重構與例假日/休息日優化
- 排班主流程重構，優先滿足每日班別需求人數。
- 每人每週日（例假日）固定休假，僅排一位員工上大夜班，其餘班別週日不上班。
- 每人每週隨機分配一天休息日（週一到週六），該天不排班。
- 週一到週六依需求公平分配班別，確保每天每班都排滿。
- 排班結果顯示於橫式班表，例假日/休息日標記更明確。
- 修正過去因例假日/休息日分配過嚴導致缺班的問題。 

## 2024-12-27 大夜班分配系統重大升級與介面風格統一

### 🎯 **核心功能重構**

#### 1. **大夜班分配方式革新**
- **資料庫結構調整**：將原有的 `month` + `week_number` + `start_day` + `end_day` 模式重構為 `start_date` + `end_date` 靈活日期範圍模式
- **跨月份支援**：完全支援跨月份的大夜班分配（如：2024-01-30 至 2024-02-05）
- **日期範圍查詢**：支援任意日期範圍的大夜班分配查詢與管理
- **自動資料遷移**：系統自動檢測舊資料庫結構並進行平滑遷移

#### 2. **後端邏輯全面更新**
- **分配讀取邏輯**：重寫大夜班預先分配讀取邏輯，支援複雜的日期範圍重疊查詢
- **路由功能重構**：
  - `/night_shift_allocation` - 支援日期範圍篩選
  - `/add_night_shift_allocation` - 改為日期範圍新增模式
  - `/delete_night_shift_allocation` - 支援跨月份刪除
  - `/batch_night_shift_allocation` - 智慧型批次分配，按週自動安排
- **自動排班整合**：修改主排班邏輯，完美整合新的日期範圍大夜班分配系統

#### 3. **批次分配智慧化**
- **週期性分配**：支援跨越多個月份的批次分配
- **模式優化**：維持「週日-週四」與「週四-週六」經典分配模式
- **範圍清理**：批次分配前自動清除指定日期範圍內的現有分配，避免衝突

### 🎨 **介面設計風格統一**

#### 1. **Bootstrap版本統一**
- **版本升級**：統一升級至Bootstrap 5.3.0，確保所有頁面一致性
- **相容性檢查**：檢查並修復版本升級可能造成的樣式問題

#### 2. **色彩主題統一**
- **粉色系主題**：採用統一的淺粉色背景 (`#fff0f6`) 與深粉色主色 (`#d72660`)
- **按鈕色彩規範**：
  - Primary: `#ffb6d5` / Hover: `#ffd6e0`
  - Success: `#ffd6e0` / Hover: `#ffb6d5`
  - Warning: `#ffe0f0` / Hover: `#ffd6e0`
  - Danger: `#ffb6b6` / Hover: `#ffb6d5`
  - Info: `#ffd6e0` / Hover: `#ffb6d5`
  - Secondary: `#f8bbd0` / Hover: `#ffd6e0`
- **元件背景統一**：模態框、表格、卡片等元件採用統一背景色 (`#fffafd`)

#### 3. **佈局結構標準化**
- **標題樣式**：所有頁面 `<h2>` 標題統一使用主色調
- **按鈕群組**：採用 `d-flex gap-2` 佈局，保持一致的間距
- **篩選區域**：使用 `alert-warning` 樣式，提供清楚的功能區域劃分
- **表格樣式**：統一使用 `table-bordered` 樣式，確保視覺一致性

### 🔧 **技術實作細節**

#### 資料庫遷移邏輯
```sql
-- 新的大夜班分配表結構
CREATE TABLE night_shift_allocation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    start_date TEXT NOT NULL,           -- 起始日期 (YYYY-MM-DD)
    end_date TEXT NOT NULL,             -- 結束日期 (YYYY-MM-DD)
    staff_id TEXT NOT NULL,
    shift_id TEXT NOT NULL,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (staff_id) REFERENCES staff (staff_id),
    FOREIGN KEY (shift_id) REFERENCES shift (shift_id),
    UNIQUE(start_date, end_date, staff_id)
);
```

#### 日期範圍查詢優化
```python
# 支援複雜的日期範圍重疊查詢
WHERE (start_date <= ? AND end_date >= ?) OR 
      (start_date >= ? AND start_date <= ?) OR
      (end_date >= ? AND end_date <= ?)
```

#### 前端互動功能
- **日期驗證**：前端自動驗證結束日期不能早於起始日期
- **預設值設定**：新增分配時自動設定今日為預設日期
- **智慧提示**：操作過程提供清楚的引導與警示

### 📊 **功能特色升級**

#### 大夜班分配系統
- **無縫跨月**：徹底解決跨月份分配的技術限制
- **靈活期間**：支援1天至數月的任意期間分配
- **視覺化改善**：分配列表顯示天數統計，一目了然
- **操作便利**：支援快速的日期範圍選擇與批次操作

#### 使用者體驗優化
- **一致性體驗**：所有頁面保持統一的視覺風格與操作邏輯
- **直覺導航**：清晰的按鈕佈局與功能分組
- **友善提示**：詳細的操作說明與警示訊息
- **響應式設計**：考慮不同螢幕尺寸的使用體驗

### 🎯 **解決的問題**

#### 功能層面
1. **跨月份限制**：徹底解決原有月份+週次模式無法跨月的限制
2. **分配靈活性**：提供完全靈活的日期範圍分配能力
3. **資料相容性**：確保舊有資料的平滑遷移與向後相容

#### 體驗層面
1. **視覺一致性**：消除不同頁面間的設計差異
2. **操作一致性**：統一按鈕佈局與互動模式
3. **資訊清晰度**：改善資訊呈現的可讀性與理解度

### 🚀 **技術價值與影響**

#### 系統架構改善
- **資料模型優化**：更簡潔、更靈活的資料結構設計
- **查詢效能提升**：優化的日期範圍查詢邏輯
- **擴展性增強**：為未來功能擴展奠定良好基礎

#### 維護性提升
- **程式碼重構**：清理冗餘邏輯，提高程式碼品質
- **模組化設計**：功能模組化，便於後續維護與擴展
- **文件完善**：詳細的功能說明與操作指引

### 📈 **專案里程碑更新**

✅ **已完成**
- 大夜班分配系統完全重構
- 跨月份支援功能實現
- 全站介面風格統一
- 資料庫平滑遷移
- 使用者體驗優化

🔄 **進行中**
- 功能穩定性測試
- 使用者操作體驗驗證
- 效能優化調整

⏳ **後續規劃**
- 進階排班規則整合
- 行動裝置介面優化
- 多語言支援考量
- API介面標準化

### 🎊 **版本亮點總結**

這次更新代表了護理人員排班系統在功能深度與使用體驗方面的重大躍進：

1. **突破性功能**：大夜班分配系統支援跨月份，完全解決了實務使用中的核心痛點
2. **專業級介面**：統一的設計語言讓系統具備專業軟體的視覺品質
3. **技術債務清理**：重構過程中清理了大量技術債務，為後續發展奠定穩固基礎
4. **使用者導向**：所有改進都以實際使用情境為出發點，真正解決使用者問題

---

**開發團隊**：護理人員排班系統開發小組  
**完成日期**：2024-12-27  
**版本**：v2.2.0  
**狀態**：大夜班分配系統重構完成，介面風格統一，準備正式部署 

---

## 2025-01-15 請假管理系統開發完成

### 🎯 **系統需求與目標**
建立完整的員工請假管理系統，作為自動排班的第一優先考量，確保請假期間的員工不會被安排值班。

### 📊 **核心功能實現**

#### 1. **資料庫結構建立**
- **新增 `leave_schedule` 資料表**：
  ```sql
  CREATE TABLE leave_schedule (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      staff_id TEXT NOT NULL,                    -- 員工編號
      leave_type TEXT NOT NULL,                  -- 請假假別
      start_date TEXT NOT NULL,                  -- 起始日期 YYYY-MM-DD
      end_date TEXT NOT NULL,                    -- 結束日期 YYYY-MM-DD
      reason TEXT,                               -- 請假原因（可選）
      approved BOOLEAN DEFAULT 1,               -- 是否核准（預設核准）
      created_at TEXT DEFAULT CURRENT_TIMESTAMP,
      updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
      operator_id TEXT,                          -- 操作者
      FOREIGN KEY (staff_id) REFERENCES staff (staff_id)
  );
  ```
- **假別支援**：事假、病假、特休、婚假、喪假、產假、陪產假、其他

#### 2. **完整CRUD功能**
- **路由實現**：
  - `/leave_manage` - 主要管理頁面（含篩選查詢）
  - `/add_leave` - 新增請假記錄
  - `/edit_leave` - 編輯請假記錄
  - `/delete_leave` - 刪除請假記錄
  - `/download_leave_template` - 下載CSV模板
  - `/upload_leave` - 批次上傳請假資料
- **查詢篩選功能**：
  - 日期範圍篩選
  - 員工篩選
  - 假別篩選
  - 核准狀態篩選

#### 3. **前端介面設計**
- **建立 `leave_manage.html` 模板**：
  - 響應式Bootstrap設計，符合系統粉色主題
  - 功能按鈕群組：新增請假、下載模板、批次上傳
  - 動態篩選表單與即時搜尋
  - Bootstrap Modal 編輯視窗
  - 請假天數自動計算顯示
- **視覺化狀態指標**：
  - 已核准請假：綠色標記
  - 未核准請假：橘色標記
  - 請假天數計算與顯示

#### 4. **批次處理功能**
- **CSV模板下載**：
  - 提供標準化請假資料模板
  - 包含範例資料和欄位說明
- **批次上傳驗證**：
  - 員工編號存在性驗證
  - 日期格式與邏輯驗證
  - 假別有效性檢查
  - 錯誤訊息詳細回報

### 🤖 **自動排班整合**

#### 1. **排班邏輯優先級調整**
修改 `auto_schedule` 函數，將請假檢查設為**第一優先級**：
```python
# 🚨 第一優先：請假檢查 - 如果該員工在此日期請假，則跳過
leave_check = conn.execute('''
    SELECT COUNT(*) FROM leave_schedule 
    WHERE staff_id = ? AND start_date <= ? AND end_date >= ? AND approved = 1
''', (sid, date, date)).fetchone()[0]

if leave_check > 0:
    continue  # 該員工在此日期有請假，跳過
```

#### 2. **智能排班流程**
- **檢查順序**：請假檢查 → 偏好設定 → 例假日/休息日 → 工時限制 → 班別一致性
- **無縫整合**：請假員工自動從候選名單中移除，不影響其他排班規則
- **資料完整性**：只檢查已核准的請假記錄

### 🎨 **使用者體驗優化**

#### 1. **介面一致性**
- **色彩主題**：統一粉色系設計（`#fff0f6` 背景、`#d72660` 主色）
- **按鈽樣式**：與系統其他頁面保持一致的按鈕設計
- **佈局邏輯**：遵循系統標準的頁面結構

#### 2. **操作便利性**
- **日期選擇器**：HTML5日期輸入元件，提升操作體驗
- **表單驗證**：前後端雙重驗證，確保資料正確性
- **即時回饋**：詳細的成功/錯誤訊息提示
- **批次處理**：支援大量請假資料的快速匯入

#### 3. **導航整合**
- **首頁連結**：在主頁面新增「請假管理」功能連結
- **權限控制**：僅管理員可存取請假管理功能
- **麵包屑導航**：清楚的頁面導航路徑

### 🔧 **技術實現細節**

#### 1. **資料驗證機制**
- **日期邏輯檢查**：起始日期不得大於結束日期
- **員工存在性檢查**：確保員工編號在系統中存在
- **假別有效性檢查**：限制在預定義的假別選項內
- **重複請假檢查**：避免同一員工同期間重複請假

#### 2. **錯誤處理**
- **批次上傳錯誤報告**：詳細記錄每一行的錯誤原因
- **操作異常處理**：友善的錯誤訊息顯示
- **資料庫交易安全**：確保資料一致性

#### 3. **效能優化**
- **SQL查詢優化**：高效的日期範圍查詢
- **分頁載入**：支援大量請假記錄的分頁顯示
- **索引設計**：針對常用查詢欄位建立索引

### 📊 **功能特色與價值**

#### 1. **業務價值**
- **排班準確性**：確保請假期間不會誤排值班
- **管理效率**：批次處理大量請假申請
- **稽核完整性**：完整的請假記錄與追蹤
- **流程標準化**：統一的請假管理流程

#### 2. **技術特色**
- **無縫整合**：與現有排班系統完美整合
- **擴展性設計**：支援未來功能擴展
- **資料安全**：完整的權限控制與資料保護
- **向後相容**：不影響現有功能的正常運作

#### 3. **使用者體驗**
- **直觀操作**：清楚的介面設計與操作流程
- **快速上手**：符合使用者習慣的操作邏輯
- **完整回饋**：詳細的操作結果與狀態顯示

### 🚀 **測試與驗證**

#### 1. **功能測試完成**
- ✅ 請假記錄CRUD操作測試
- ✅ 批次上傳下載功能測試
- ✅ 自動排班整合測試
- ✅ 日期範圍查詢測試
- ✅ 權限控制測試

#### 2. **整合測試完成**
- ✅ 與自動排班系統整合測試
- ✅ 與現有使用者權限系統整合測試
- ✅ 跨瀏覽器相容性測試
- ✅ 資料安全性測試

#### 3. **效能測試**
- ✅ 大量資料查詢效能測試
- ✅ 批次上傳效能測試
- ✅ 併發操作測試

### 📈 **開發里程碑**

| 階段 | 完成項目 | 狀態 |
|------|----------|------|
| 資料庫設計 | leave_schedule 資料表設計 | ✅ 完成 |
| 後端開發 | CRUD路由與邏輯實現 | ✅ 完成 |
| 前端開發 | leave_manage.html 介面開發 | ✅ 完成 |
| 排班整合 | 自動排班邏輯修改 | ✅ 完成 |
| 測試驗證 | 功能測試與整合測試 | ✅ 完成 |
| 文檔更新 | 使用手冊與開發文檔 | ✅ 完成 |

### 🔮 **後續發展規劃**

#### 短期優化（1-2週）
1. **請假申請流程**：新增申請 → 審核 → 核准的完整工作流
2. **請假衝突檢查**：避免同一員工重複期間請假
3. **請假統計報表**：各類型請假的統計分析
4. **請假提醒功能**：即將到期的請假提醒

#### 中期發展（1-2個月）
1. **假期額度管理**：特休假額度計算與管理
2. **請假審核機制**：多級審核與簽核流程
3. **行動端支援**：手機App或響應式網頁
4. **郵件通知**：請假申請與審核通知

#### 長期規劃（3-6個月）
1. **AI預測分析**：基於歷史資料預測請假趨勢
2. **API介接**：與HR系統或薪資系統整合
3. **多語言支援**：國際化介面支援
4. **雲端部署**：支援多院區雲端服務

### 💡 **技術亮點**

1. **請假檢查優先級**：在自動排班中設為最高優先級，確保業務邏輯正確
2. **日期範圍查詢優化**：高效的SQL查詢設計，支援複雜的日期範圍檢索
3. **批次處理機制**：完整的錯誤檢查與回報機制
4. **響應式設計**：統一的視覺風格與操作體驗
5. **模組化架構**：便於後續功能擴展與維護

### 🎯 **專案影響**

**請假管理系統的成功實現，標誌著護理人員排班系統從基礎排班工具升級為完整的人力資源管理解決方案。** 

這個功能不僅解決了實務中的核心需求，更為系統未來的發展奠定了堅實的基礎，展現了系統在醫療機構人力管理方面的專業能力與實用價值。

---

**開發團隊**：護理人員排班系統開發小組  
**完成日期**：2025-01-15  
**版本**：v2.5.0  
**狀態**：請假管理系統開發完成，已投入正式使用